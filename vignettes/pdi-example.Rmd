---
title: "Generating phenotypic decline indexes using the pdi package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generating phenotypic decline indexes using the pdi package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = 'center'
)
```

## Introduction

To begin, load the package:

```{r library_load,message=FALSE}
library(pdi)
```

The following example example will also make use the dplyr package for data manipulation, ggplot2 for visualisation and the pipe (`%>%`) from the magrittr package.
The additional packages can be loaded using:

```{r additional_libraries,message=FALSE}
library(dplyr)
library(ggplot2)
```

## Example Data

For this example, we will be using phenotypic data provided within the package.
This consists of data collected from two woodlands each with 20 oak trees surveyed.
The trees were manually assigned an oak decline status with 10 decline symptomatic and 10 decline non-symptomatic trees at each site.

The file paths for the example data can be retrieved with the following:

```{r file_paths}
files <- list.files(
  system.file('phenotypeDataCollectionSheets',
              package = 'pdi'),
  full.names = TRUE) 
```

For collecting further data, a clean copy of the phenotyping data collection sheet template can be exported using:

```{r template,eval=FALSE}
phenotypingTemplate(path = '.')
```

## Index generation

### Data preparation

There are several steps involved the initial preparation of the example phenotypic data collection sheets.

Firstly, the sheets can be parsed to give a list object containg the raw data for each site using:

```{r read_files}
d <- map(files,readPhenotypeSheet)
```

These can then be assembled into a single tibble with the following:

```{r prepare_data}
p <- map(d,preparePhenotypeData) %>%
  bind_rows()
```

As shown below, this provides a tibble containing `r ncol(p)` phenotypic descriptors for the `r nrow(p)` trees across the two sites.

```{r data}
p
```

### Tree size descriptor adjustment

```{r DBH_site_plot}
ggplot(p,aes(x = Location,y = `Diameter at breast height (m)`)) +
  geom_boxplot() +
  theme_bw()
```

```{r site_adjustment}
sa <- siteAdjustment(p)
```

```{r DBH_site_adjusted_plot}
ggplot(sa,aes(x = Location,y = `Diameter at breast height (m)`)) +
  geom_boxplot() +
  theme_bw()
```

```{r}
sa_factors <- siteAdjustmentFactors(p)
sa_factors
```

### Additional descriptors calculation

Composite descriptors can 

The additional descriptors provided by pdi include:

* `liveCrownRatio` - Live crown ratio (%)
* `crownCondition` - Crown condition (%)
* `crownVolume` - Crown volume (m^3^)
* `bleedPrevalence` - Bleed prevalence (%)
* `agrilusExitHoleDensity` - Agrilus exit hole density (m^2^)

The additional descriptors can be calculate for the example data using:

```{r additional_descriptors}
a <- sa %>%
  mutate(`Live crown ratio (%)` = liveCrownRatio(`Total height (m)`,
                                                 `Lower crown height (m)`),
         `Crown condition (%)` = crownCondition(`Missing crown (%)`,
                                                `Crown transparency (%)`),
         `Crown volume (m^3)` = crownVolume(`Crown radius (m)`,
                                            `Total height (m)`,
                                            `Lower crown height (m)`,
                                            `Crown condition (%)`),
         `Bleed prevalence (%)` = bleedPrevalence(`Active bleed length (mm)`,
                                                  `Active bleeds`,
                                                  `Black staining length (mm)`,
                                                  `Black staining`,
                                                  `Diameter at breast height (m)`),
         `Agrilus exit hole density (m^-2)` = agrilusExitHoleDensity(`Agrilus exit holes`,
                                                                     `Diameter at breast height (m)`)
  )
```

### Random forest

```{r prepare_data_for_rf}
t <- makeAnalysisTable(a)
```

```{r random_forest}
m <- rf(t,cls = NULL,nreps = 10)
```

### Index calculation

```{r calculate_DIs}
DIs <- calcDIs(m,DAI = FALSE,invertPDI = FALSE) %>%
  bind_cols(a %>%
              select(Location,ID,Status))
```

```{r,fig.width=7}
ggplot(DIs,aes(x = Status,y = PDI)) +
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~Location)
```

### Descriptor contributions

```{r contributions}
descriptor_contributions <- m %>%
  descriptorContributions()
```

```{r contributions_plot, fig.height=6,fig.width=5}
descriptor_contributions %>%
  arrange(MeanDecreaseAccuracy) %>%
  mutate(Descriptor = factor(Descriptor,levels = Descriptor)) %>%
  ggplot(aes(x = MeanDecreaseAccuracy,y = Descriptor)) +
  geom_point() +
  theme_bw()
```

```{r crown_volume_plot}
DIs %>%
  bind_cols(a %>%
              select(`Crown volume (m^3)`)) %>%
  ggplot(aes(x = PDI,y = `Crown volume (m^3)`)) +
  geom_point() +
  theme_bw()
```

